machine:
  pre:
    - echo 'DOCKER_OPTS="-s btrfs -e lxc -D --userland-proxy=false"' | sudo tee -a /etc/default/docker
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci-cp-workaround'
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - docker info
    - cd deploy/e2e && chmod 755 ensurePermissions && ./ensurePermissions
    - cd deploy/e2e && ./loadContainers
    - cd deploy/e2e && ./buildContainers $CIRCLE_BUILD_NUM
    - cd deploy/e2e && ./runContainers $CIRCLE_BUILD_NUM
    - cd deploy/e2e && ./saveContainers

test:
  override:
    - docker ps
    - for i in {1..10}; do curl http://localhost:2113/web/index.html && break; sleep 1; if [[ $i == 10 ]];then false;fi; done
    - . ./deploy/config && docker run -a STDOUT --net=host $serversContainer.$CIRCLE_BUILD_NUM bash -c "dnx --configuration Release -p Adaptive.ReactiveTrader.Server.IntegrationTests test -parallel none"

deployment:
  hub:
    branch: [master]
    commands:
      - cd deploy/e2e && ./pushContainers $CIRCLE_BUILD_NUM
