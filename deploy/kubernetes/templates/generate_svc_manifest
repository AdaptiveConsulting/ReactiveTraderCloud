#! /bin/bash

if [[ $# < 2 ]];then
  echo "parameter error: "
  echo "  usage:"
  echo "  $0 SERVICE NAMESPACE [BUILD_ID]"
  exit 1
fi
service=$1
namespace=$2

# load configuration and libs
root_directory="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../../.."
. ${root_directory}/deploy/config
. ${root_directory}/deploy/kubernetes/helpers/functions.sh

# define version
if [[ $service == "broker" ]];then
  vMajor=$brokerContainer_major
  vMinor=$brokerContainer_minor
fi
if [[ $service == "web" ]];then
  vMajor=$webContainer_major
  vMinor=$webContainer_minor
fi
if [[ $service == "eventstore" ]];then
  vMajor=$populatedEventstoreContainer_major
  vMinor=$populatedEventstoreContainer_minor
fi

dotnetServices="analytics blotter pricing referencedataread tradeexecution"
if listcontains "$dotnetServices" $service; then
  vMajor=$serversContainer_major
  vMinor=$serversContainer_minor
fi

# fill manifest
manifests_directory="${root_directory}/deploy/kubernetes/manifests"
mkdir -p ${manifests_directory}
service_manifest="${manifests_directory}/$service-svc.yml"
cp ./$service/svc.yml ${service_manifest}

sed -ie "s/__SERVICE__/$service/g"     ${service_manifest}
sed -ie "s/__MAJOR__/$vMajor/g"        ${service_manifest}
sed -ie "s/__MINOR__/$vMinor/g"        ${service_manifest}
sed -ie "s/__NAMESPACE__/$namespace/g" ${service_manifest}
