worker_processes  1;

pid               /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  sendfile      on;
  default_type  application/octet-stream;

  server_names_hash_bucket_size   128;

  log_format upstreamlog
    '=======================================================\n'
    'nsgate-version             __WEB_VERSION__\n'
    'date_gmt                   \$date_gmt\n'
    'cookie_                    \$cookie_\n'
    'host                       \$host\n'
    'hostname                   \$hostname\n'
    'proxy_add_x_forwarded_for  \$proxy_add_x_forwarded_for\n'
    'proxy_host                 \$proxy_host\n'
    'proxy_port                 \$proxy_port\n'
    'query_string               \$query_string\n'
    'realip_remote_addr         \$realip_remote_addr\n'
    'realip_remote_port         \$realip_remote_port\n'
    'realpath_root              \$realpath_root\n'
    'remote_addr:               \$remote_addr\n'
    'remote_port:               \$remote_port\n'
    'remote_user:               \$remote_user\n'
    'request:                   \$request\n'
    'request_body:              \$request_body\n'
    'request_id:                \$request_id\n'
    'scheme                     \$scheme\n'
    'server_addr:               \$server_addr\n'
    'server_name:               \$server_name\n'
    'server_port:               \$server_port\n'
    'server_protocol:           \$server_protocol\n'
    'session_log_binary_id      \$session_log_binary_id\n'
    'session_log_id             \$session_log_id\n'
    'status:                    \$status\n'
    'upstream_addr:             \$upstream_addr\n'
    ;
  error_log     /dev/stderr upstreamlog;
  access_log    /dev/stdout upstreamlog;

  # static content
  # ==============
  server {
    listen 80;

    location / {

      # tag
      add_header  X-ReactiveTraderCloud-Proxy-Web-Config  'static-content';
      add_header  X-ReactiveTraderCloud-Proxy-Wev-Version '__WEB_VERSION__';

      # cors
      # add_header  Access-Control-Allow-Origin   '*';
      # add_header  Access-Control-Allow-Methods  'GET, POST, OPTIONS';
      # add_header  Access-Control-Allow-Headers  'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

      # host content
      expires     -1;
      root        /www;
    }
  }



  # redirection to broker
  # =====================
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  server {
    listen 8080;

    location / {
      # tag
      add_header  X-ReactiveTraderCloud-Proxy-Web-Config  'broker';
      add_header  X-ReactiveTraderCloud-Proxy-Version     '__WEB_VERSION__';

      # cors
      # add_header  Access-Control-Allow-Origin   '*';
      # add_header  Access-Control-Allow-Methods  'GET, POST, OPTIONS';
      # add_header  Access-Control-Allow-Headers  'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

      # proxy
      proxy_pass        http://broker:8080;
      # proxy_set_header  Host              $host;
      # proxy_set_header  X-Real-IP         $remote_addr;
      # proxy_set_header  X-Forwarded-Proto $scheme;
      # proxy_set_header  X-Forwarded-For   '$proxy_add_x_forwarded_for, $server_addr';

      # ws
      proxy_http_version        1.1;
      proxy_set_header          Upgrade                       $http_upgrade;
      proxy_set_header          Connection                    $connection_upgrade;
      # proxy_ignore_client_abort off;
      # proxy_buffering           off;
    }
  }
}
