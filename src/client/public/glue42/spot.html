<html>
<head>
  <style type="text/css">
    body {
      margin: 0;
    }
    iframe {
      display: block;
      background: #000;
      border: none;
      height: 100vh;
      width: 100vw;
    }
  </style>
  <script type="text/javascript" src="tick42-glue/tick42-glue.min.js"></script>
  <script>
    // Eikon application and authentication details.
    const productId = 'JPMORGANCHASECO.COMGLUE42TEST';
    const apiKey = '24fedf49871e4bc78c5568460849348a40abb9ff';
    let sessionToken;

    // List of the Eikon Channels.
    // [
    //   { channelId: 5, color: "#DD2C3C" }, // Red.
    //   { channelId: 2, color: "#A011FF" }, // Purple.
    //   { channelId: 1, color: "#0658FE" }, // Blue.
    //   { channelId: 3, color: "#0CAE51" }, // Green.
    //   { channelId: 4, color: "#E7E355" } // Yellow.
    // ]

    // Eikon Channel Id to broadcast to.
    const eikonChannelIdToBroadcastTo = 5;

    window.onload = () => {
      Glue({channels: true}).then((glue) => {
        window.glue = glue;
        setUrlSrc(glue.windows.my().context.symbol)

        subscribeForGlueChannels()

        // Send a handshake request on application start.
        sendHandshakeRequest()
        // The sendHandshakeRequest method resolves with a response containing the sessionToken that is needed for all future requests.
          .then((response) => {
            sessionToken = response.sessionToken;
            return sendJoinRedColorChannelRequest();
          })
          .catch((error) => {
            console.error('Handshake with SxS failed! ', error);
          });
      });
    };

    const setUrlSrc = (symbol) => {
      if (!symbol) {
        symbol = 'GBPJPY'
      }
      document.getElementById('appHost').src = `http://localhost:3000/spot/${symbol}?tileView=Normal`;
      glue.agm.invoke('updateContext', {symbol});
    }

    const subscribeForGlueChannels = () => {
      glue.channels.subscribe(({symbol}) => {
        setUrlSrc(symbol)
        sendContextChangedRequestForRedChannel(symbol)
      })
    }

    // Method that performs the initial handshake with Eikon and subscribes to the side by side notifications API.
    const sendHandshakeRequest = () => new Promise((resolve, reject) => {
      const body = {
        command: 'handshake',
        productId,
        apiKey
      };

      const callback = (response) => {
        // Open a websocket with the Eikon's notifications API.
        window.ws = new WebSocket(`ws://localhost:9000/sxs/v1/notifications?sessionToken=${response.sessionToken}&linkType=3`);

        ws.onopen = () => {
          resolve(response);
        };

        // The onmessage callback is called whenever the channel's context is changed.
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          const newContext = data.context;
          if (typeof newContext === 'undefined') {
            return;
          }
          const entitites = JSON.parse(newContext).entities;
          const ric = entitites && entitites.length === 1 ? entitites[0].RIC : null;
          const symbol = ric ? ric.split('=')[0] : null;
          if (!symbol || symbol.length !== 6) {
            return;
          }

          document.getElementById('appHost').src = `http://localhost:3000/spot/${symbol}?tileView=Normal`;

          // TODO move to FDC3 context
          glue.channels.publish({symbol});
        };
      };

      sendSxsPostRequest(body, callback, reject);
    });

    // Method that updates the RIC inside the eikonChannelIdToBroadcastTo.
    const sendContextChangedRequestForRedChannel = ( symbol ) => new Promise((resolve, reject) => {
      const body = {
        command: 'contextChanged',
        sessionToken,
        channelId: eikonChannelIdToBroadcastTo,
        context: {
          entities: [{
            RIC: `${symbol}=`
          }]
        }
      };

      sendSxsPostRequest(body, resolve, reject);
    });

    // Method that sends a side by side API POST request.
    const sendSxsPostRequest = (body, callback, errorCallback) => {
      const stringifiedBody = JSON.stringify(body);
      const sxsUrl = 'http://127.0.0.1:9000/sxs/v1';

      const xhr = new XMLHttpRequest();

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            callback(response);
          } else {
            errorCallback();
          }
        }
      };

      xhr.open('POST', sxsUrl, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
      xhr.send(stringifiedBody);
    };

    // Method that joins the running application instance to the eikonChannelIdToBroadcastTo.
    const sendJoinRedColorChannelRequest = () => new Promise((resolve, reject) => {
      const body = {
        command: 'joinColorChannel',
        sessionToken,
        channelId: eikonChannelIdToBroadcastTo
      };

      sendSxsPostRequest(body, resolve, reject);
    });
  </script>
</head>
<body>
  <iframe id="appHost"></iframe>
</body>
</html>
